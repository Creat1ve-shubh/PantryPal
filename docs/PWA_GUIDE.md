# Progressive Web App (PWA) Implementation Guide

## ğŸ“± What is PWA?

A **Progressive Web App (PWA)** is a web application that combines the best features of websites and native mobile apps:

| Feature            | Traditional Web | Native App | PWA           |
| ------------------ | --------------- | ---------- | ------------- |
| Installation       | âŒ              | âœ…         | âœ…            |
| Offline Support    | âŒ              | âœ…         | âœ…            |
| Push Notifications | âŒ              | âœ…         | â³ (Optional) |
| App Icon           | âŒ              | âœ…         | âœ…            |
| Full Screen        | âŒ              | âœ…         | âœ…            |
| Fast Loading       | âš ï¸              | âœ…         | âœ…            |
| No App Store       | âœ…              | âŒ         | âœ…            |

---

## ğŸ—ï¸ How PWA is Implemented in PantryPal

### 1. **Vite PWA Plugin** (`vite.config.ts`)

PantryPal uses [vite-plugin-pwa](https://vite-pwa-org.netlify.app/) to automatically generate PWA assets during build.

**Configuration**:

```typescript
VitePWA({
  registerType: "autoUpdate",    // Auto-update service worker
  includeAssets: ["favicon.ico", "robots.txt", "apple-touch-icon.png"],
  manifest: { ... },              // Web app manifest
  workbox: { ... }                // Caching strategies
})
```

### 2. **Web App Manifest** (`manifest.webmanifest`)

Generated during build. Defines app metadata and icons.

**Key Fields**:

- `name`: "PantryPal" (full name)
- `short_name`: "PantryPal" (home screen label, max 12 chars)
- `description`: "Professional Inventory & Pantry Management"
- `theme_color`: "#0f172a" (status bar color on mobile)
- `background_color`: "#ffffff" (splash screen background)
- `display`: "standalone" (hides browser UI, looks like native app)
- `icons`: Array of icon sizes (192x192, 512x512, maskable)

### 3. **Service Worker** (`sw.js`)

Auto-generated by Vite PWA. Handles:

- âœ… Offline caching
- âœ… Background synchronization
- âœ… Push notifications (optional)
- âœ… Resource precaching

**Service Worker Lifecycle**:

```
Install â†’ Activate â†’ Fetch/Message Events
  â†“
Auto-updated when new version deployed
```

### 4. **Caching Strategies**

#### Strategy 1: **Cache First** (Static Assets)

```
User Request â†’ Check Cache â†’ Found? Return cached â†’ Not found? Fetch from network
```

**Used for**: Google Fonts, static assets
**TTL**: 1 year

#### Strategy 2: **Network First** (API Calls)

```
User Request â†’ Fetch from network â†’ Fallback to cache â†’ Offline? Return cached
```

**Used for**: `/api/*` endpoints
**TTL**: 24 hours
**Timeout**: 10 seconds

#### Strategy 3: **Stale While Revalidate** (Default)

```
Return cached immediately â†’ Fetch fresh in background
```

**Used for**: All other resources

### 5. **Install Prompt Hook** (`use-pwa-install.ts`)

Triggers native "Install App" dialog on browsers that support PWA.

```typescript
const { isInstallable, install } = usePWAInstall();

// Show button if app is installable
if (isInstallable) {
  <button onClick={install}>Install PantryPal</button>;
}
```

---

## ğŸš€ How to Build & Test PWA

### Step 1: Build with PWA Assets

```bash
npm run build
```

**Output files generated**:

```
dist/
â”œâ”€â”€ index.html
â”œâ”€â”€ manifest.webmanifest      â† Web app manifest
â”œâ”€â”€ sw.js                     â† Service worker
â”œâ”€â”€ workbox-*.js              â† Caching libraries
â”œâ”€â”€ pwa-192x192.png           â† Icon (192x192)
â”œâ”€â”€ pwa-512x512.png           â† Icon (512x512)
â””â”€â”€ assets/
    â”œâ”€â”€ index-*.js            â† App bundle
    â””â”€â”€ index-*.css           â† Styles
```

**Verify PWA files generated**:

```bash
# Check manifest exists
ls -la dist/manifest.webmanifest

# Check service worker exists
ls -la dist/sw.js

# Check icons exist
ls -la dist/pwa-*.png
```

---

## ğŸ§ª Manual Testing - Step by Step

### **Test 1: Install PWA on Desktop (Chrome)**

**Prerequisites**:

- Build complete (`npm run build`)
- Serve built files: `npm run start` or `npx http-server dist/`

**Steps**:

1. Open DevTools: `F12`
2. Go to **Application** tab
3. Click **Manifest** on left sidebar
4. Verify manifest loads without errors:

   ```json
   {
     "name": "PantryPal",
     "short_name": "PantryPal",
     "display": "standalone",
     "icons": [...]
   }
   ```

5. **Look for Install Button** (top-right address bar):

   - ![Install Icon] button appears automatically
   - Click it â†’ "Install PantryPal" dialog appears
   - Click **Install**

6. **Verify Installation**:
   - App window opens in standalone mode (no address bar)
   - App appears in Windows Start menu / Mac Applications
   - Taskbar shows "PantryPal" icon

**Success Indicators**:

- âœ… Manifest valid (no errors in DevTools)
- âœ… Service worker registered (DevTools â†’ Application â†’ Service Workers)
- âœ… Install button appears
- âœ… App opens in fullscreen without browser UI

---

### **Test 2: Offline Functionality**

**Prerequisites**:

- PWA installed (Test 1 complete)

**Steps**:

1. **Open installed PantryPal app**
2. **Go to DevTools â†’ Network tab**
3. **Navigate to barcode scanner**: `/barcode-scanner`
4. **Enable offline mode**:

   - DevTools â†’ Network tab
   - Check **Offline** checkbox
   - Reload page (`Ctrl+R`)

5. **Verify offline behavior**:

   - âœ… App loads from cache (instant, no network requests)
   - âœ… UI renders correctly
   - âœ… Cart data shows (from localStorage)
   - âœ… Cached pages work

6. **Verify online-only features fail gracefully**:

   - Try to fetch products via barcode (API calls)
   - Should show: "No network connection" or use cached data
   - No app crash

7. **Turn offline off and refresh**:
   - Uncheck **Offline**
   - Reload (`Ctrl+R`)
   - âœ… App syncs with server
   - âœ… New data loads

**Success Indicators**:

- âœ… App loads instantly offline from cache
- âœ… No console errors
- âœ… Navigation works (cached pages)
- âœ… Graceful error handling (API failures show message)

---

### **Test 3: Cache Behavior (DevTools)**

**Steps**:

1. **Open DevTools â†’ Application â†’ Cache Storage**
2. **Expected caches**:

   ```
   google-fonts-cache         â† Font cache (1 year TTL)
   gstatic-fonts-cache        â† Google static assets
   api-cache                  â† API responses (24h TTL)
   PantryPal-v1              â† App assets (1 month)
   ```

3. **Inspect a cache** (e.g., `api-cache`):

   - Click cache name
   - See API endpoints cached:
     ```
     /api/products/search?barcode=PROD-001
     /api/products/...
     /api/bills/...
     ```

4. **Check cache size**:

   - View â†’ Size of cached files
   - Should be reasonable (< 50MB typical)

5. **Test cache expiration**:
   - Make API call
   - Check cache added
   - Wait 24+ hours (or manually clear)
   - Cache should be purged

**Success Indicators**:

- âœ… Multiple caches present
- âœ… API responses cached correctly
- âœ… Cache sizes reasonable

---

### **Test 4: Service Worker Registration**

**Steps**:

1. **DevTools â†’ Application â†’ Service Workers**
2. **Verify service worker present**:

   ```
   Status: activated and running
   Scope: https://your-domain.com/
   ```

3. **Check Service Worker file**:

   - DevTools â†’ Network
   - Look for `sw.js` request
   - Status: 200 (from cache if offline)

4. **Simulate Push Notification** (optional):

   - Click **Push** button in DevTools
   - Enter test payload:
     ```json
     { "title": "Test Notification", "body": "Hello PantryPal" }
     ```
   - Should show notification

5. **Update Check**:
   - DevTools â†’ Application â†’ Service Workers
   - Click **Update** button
   - Service worker checks for new version
   - Auto-updates if available

**Success Indicators**:

- âœ… Service worker "activated and running"
- âœ… No errors in console
- âœ… Update button functional

---

### **Test 5: App Shortcuts (Optional)**

**Steps**:

1. **Verify app shortcuts** (if configured):

   - Right-click app icon (taskbar/home screen)
   - Should show shortcuts like:
     ```
     - New Sale
     - View Bills
     - Barcode Scanner
     ```

2. **Click a shortcut**:
   - âœ… App opens to that page directly

---

### **Test 6: Install Prompt Hook**

**Steps**:

1. **On first visit** (or after cache clear):

   - `beforeinstallprompt` event fires
   - Install button appears (if configured in UI)

2. **Click "Install PantryPal"**:

   - Native dialog appears
   - User can choose "Install" or "Cancel"

3. **Verify event handling**:
   - Console should log install outcome:
     ```
     User response to the install prompt: accepted
     ```

---

### **Test 7: Mobile Installation (iOS)**

**Prerequisites**:

- PantryPal deployed to HTTPS domain
- iOS Safari browser

**Steps**:

1. **Open app in iOS Safari**
2. **Tap Share button** (bottom)
3. **Scroll down â†’ "Add to Home Screen"**
4. **Name**: "PantryPal"
5. **Tap "Add"**
6. **Verify**:
   - âœ… App icon on home screen
   - âœ… App opens fullscreen (no Safari UI)
   - âœ… Offline caching works

---

### **Test 8: Mobile Installation (Android)**

**Prerequisites**:

- PantryPal deployed to HTTPS domain
- Android Chrome browser

**Steps**:

1. **Open app in Chrome**
2. **Tap menu (â‹®) â†’ "Install app"** OR wait for popup
3. **Tap "Install"**
4. **Verify**:
   - âœ… App shortcut on home screen
   - âœ… App opens fullscreen
   - âœ… Appears in app drawer

---

## ğŸ” Debugging PWA Issues

### **Issue: Install button doesn't appear**

**Checklist**:

- âœ… Manifest file exists (`dist/manifest.webmanifest`)
- âœ… Service worker exists (`dist/sw.js`)
- âœ… App served over **HTTPS** (required, except localhost)
- âœ… Icons exist (`dist/pwa-192x192.png`, `dist/pwa-512x512.png`)
- âœ… Manifest is valid JSON (DevTools â†’ Application â†’ Manifest)

**Fix**:

```bash
# Rebuild
npm run build

# Serve over HTTPS (or use localhost for testing)
npm run start
```

---

### **Issue: Service worker doesn't update**

**Solution**:

```javascript
// Force update check
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.ready.then((reg) => {
    reg.update(); // Check for new version
  });
}
```

---

### **Issue: Offline page shows blank**

**Solution**:

1. Check cache storage (DevTools â†’ Cache Storage)
2. Verify API cache strategy (`runtimeCaching` in vite.config.ts)
3. Add fallback offline page:

```typescript
workbox: {
  navigateFallback: "/offline.html";
}
```

---

### **Issue: Cache growing too large**

**Solution**:

```typescript
workbox: {
  runtimeCaching: [
    {
      urlPattern: /\/api\/.*/i,
      handler: "NetworkFirst",
      options: {
        cacheName: "api-cache",
        expiration: {
          maxEntries: 50, // â† Limit entries
          maxAgeSeconds: 86400, // â† 24 hours
        },
      },
    },
  ];
}
```

---

## ğŸ“Š Monitoring PWA Health

### **DevTools Lighthouse Audit**

1. **DevTools â†’ Lighthouse**
2. **Select "PWA" category**
3. **Click "Analyze page load"**

**Ideal scores**:

- Web App Manifest: âœ… Pass
- Service Worker: âœ… Pass
- HTTPS: âœ… Pass
- Installable: âœ… Pass
- Performance: âœ… > 90
- Accessibility: âœ… > 90

---

### **Manual Checklist**

- [ ] PWA installs without errors
- [ ] App launches fullscreen
- [ ] Offline mode works (DevTools Network â†’ Offline)
- [ ] Cache Storage shows proper caches
- [ ] Service Worker active and running
- [ ] No console errors
- [ ] Install prompt fires on new visit
- [ ] App icon appears correctly (desktop/mobile)

---

## ğŸš€ Production Considerations

### **HTTPS Requirement**

PWA **requires HTTPS** in production (except localhost).

```bash
# Verify HTTPS in production
curl -I https://your-domain.com
# HTTP/2 200 âœ…
```

### **Cache Busting**

Vite PWA automatically caches-bust when:

- CSS/JS content changes
- Manifest version updated
- `npm run build` executed

### **Update Strategy**

```typescript
registerType: "autoUpdate"; // Auto-install updates
// Alternative: "prompt" â†’ User chooses when to update
```

---

## ğŸ“š Resources

- [MDN PWA Docs](https://developer.mozilla.org/en-US/docs/Web/Progressive_web_apps)
- [Vite PWA Plugin](https://vite-pwa-org.netlify.app/)
- [Web App Manifest Spec](https://www.w3.org/TR/appmanifest/)
- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)

---

## ğŸ“‹ Testing Checklist

Use this checklist when deploying PWA:

- [ ] `npm run build` completes without errors
- [ ] `dist/manifest.webmanifest` exists and is valid
- [ ] `dist/sw.js` exists
- [ ] Icons exist: `dist/pwa-192x192.png`, `dist/pwa-512x512.png`
- [ ] App served over HTTPS
- [ ] Lighthouse audit passes (PWA category)
- [ ] Install button appears on desktop
- [ ] App installs and launches fullscreen
- [ ] Offline mode works
- [ ] Cache Storage shows expected caches
- [ ] Service Worker shows "activated and running"
- [ ] No console errors or warnings
- [ ] Mobile installation works (iOS + Android)

---

**Last Updated**: January 7, 2026
**Status**: âœ… Production Ready
